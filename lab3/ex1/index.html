<!-- @author Stanisław Polak <polak@agh.edu.pl> -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Animation</title>
  <!-- Dodajemy Babel, jeśli chcemy obsługę JSX, ale nie modyfikujemy oryginalnego skryptu -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
<div id="react-root"></div>
<form onsubmit="event.preventDefault();">
  <h2>requestAnimationFrame()</h2>
  <label for="counter">Counter→</label>
  <output id="counter" style="font-size: 4vh; color: red;">0</output>
  <br>
  <button id="start" onclick="startAnimation()">Start</button>
  <button id="stop" disabled onclick="stopAnimation()">Stop</button>
  <!-- ************************************************************** -->
  <hr>
  <h2>Time-consuming calculations in the main thread</h2>
  <label for="result_main">Result:</label>
  <output id="result_main">0</output>
  <br>
  <label for="iterations_main">Number of iterations:</label>
  <input id="iterations_main" type="text" value="50" onfocus="document.forms[0].result_main.value ='0'">
  <button
          onclick="document.forms[0].result_main.value = calculatePrimes(document.forms[0].iterations_main.value || 50)">Run
    calculations</button>
  <!-- ************************************************************** -->
  <h2>Time-consuming calculations in a separate thread</h2>
  <label for="result_worker">Result:</label>
  <output id="result_worker">0</output>
  <br>
  <label for="iterations_worker">Number of iterations:</label>
  <input id="iterations_worker" type="text" value="50" onfocus="document.forms[0].result_worker.value ='0'">
  <button
          onclick="calculatePrimesInBackground(document.forms[0].iterations_worker.value || 50)">Run
    calculations</button>
</form>
<script>
  let animation;
  let counter = 0;

  // Source: https://udn.realityripple.com/docs/Tools/Performance/Scenarios/Intensive_JavaScript
  function calculatePrimes(iterations) {
    let primes = [];
    for (let i = 0; i < iterations; i++) {
      let candidate = i * (1000000000 * Math.random());
      let isPrime = true;
      for (var c = 2; c <= Math.sqrt(candidate); ++c) {
        if (candidate % c === 0) {
          // not prime
          isPrime = false;
          break;
        }
      }
      if (isPrime) {
        primes.push(candidate);
      }
    }
    return primes;
  }

  function calculatePrimesInBackground(iterations) {
    try {
      let worker = new Worker("worker.js");
      worker.onmessage = function (message) {
        document.getElementById("result_worker").value = message.data;
      }
      worker.onerror = (event) => {
        alert(event.message);
      }
      worker.postMessage(iterations);
    } catch (e) {
      console.error("Worker failed to start:", e);
    }
  }

  function startAnimation() {
    document.forms[0].start.disabled = true;
    document.forms[0].stop.disabled = false;
    animation = window.requestAnimationFrame(step);
  }

  function step() {
    document.forms[0].counter.value = counter++;
    animation = window.requestAnimationFrame(step);
  }

  function stopAnimation() {
    document.forms[0].start.disabled = false;
    document.forms[0].stop.disabled = true;
    window.cancelAnimationFrame(animation)
  }
</script>

<script type="text/babel" data-type="module">
  import React from "https://esm.sh/react/?dev";
  import ReactDOMClient from "https://esm.sh/react-dom/client/?dev";

  function Counter(props) {
    const [count, setCount] = React.useState(Number(props.initial) || 0);
    const timerRef = React.useRef(null);

    const start = () => {
      if (!timerRef.current) {
        timerRef.current = setInterval(() => {
          setCount(prev => prev + 1);
        }, Number(props.delay));
      }
    };

    const stop = () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
        timerRef.current = null;
      }
    };

    return (
            <div style={{ backgroundColor: "green", borderRadius: 5, padding: "10px", margin: "10px" }}>
              <div>
                <p>
                  Counter → <span style={{ color: "red" }}>{count}</span>
                </p>
              </div>
              <div>
                <button onClick={start}>Start</button>
                <button onClick={stop}>Stop</button>
              </div>
            </div>
    );
  }

  const container = document.getElementById("react-root");
  const root = ReactDOMClient.createRoot(container);
  root.render(
          <>
            <Counter initial="10" delay="1000" />
            <Counter initial="15" delay="500" />
          </>
  );
</script>
</body>
</html>
